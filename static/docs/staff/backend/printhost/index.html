<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-staff/backend/printhost">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Printhost | OCF Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://new.ocf.berkeley.edu/docs/staff/backend/printhost"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Printhost | OCF Docs"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://new.ocf.berkeley.edu/docs/staff/backend/printhost"><link data-rh="true" rel="alternate" href="https://new.ocf.berkeley.edu/docs/staff/backend/printhost" hreflang="en"><link data-rh="true" rel="alternate" href="https://new.ocf.berkeley.edu/docs/staff/backend/printhost" hreflang="x-default"><link rel="stylesheet" href="/docs/assets/css/styles.3979abba.css">
<link rel="preload" href="/docs/assets/js/runtime~main.a314d0f9.js" as="script">
<link rel="preload" href="/docs/assets/js/main.4f9c1481.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OCF Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ocf/ocfstatic/tree/master/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Source<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Home</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/internal/about/">internal</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/services/account/">services</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/staff/backend/">staff</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/staff/backend/">Infrastructure</a><button aria-label="Toggle the collapsible sidebar category &#x27;Infrastructure&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/backups">Backups</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/firewall">External firewall</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/git">Git</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/internal-firewalls">Internal firewalls</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/jenkins">Jenkins</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/kerberos">Kerberos</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/kubernetes">Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/ldap">LDAP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/libvirt">KVM/Libvirt</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staff/backend/mail/">Mail</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mail&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/munin">Munin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/staff/backend/printhost">Printhost</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/prometheus">Prometheus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/puppet">Puppet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/rt">Request Tracker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/backend/switch">Managed switches</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/getinvolved">Getting Involved</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/i3wm">i3wm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/mailing-lists">Staff mailing lists</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staff/policies/">Staff policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Staff policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/powers">Staff privileges</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/private">Additional documentation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staff/procedures/">Procedures</a><button aria-label="Toggle the collapsible sidebar category &#x27;Procedures&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staff/rebuild/">Rebuild</a><button aria-label="Toggle the collapsible sidebar category &#x27;Rebuild&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staff/scripts/">Scripts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Scripts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staff/startertasks/">Starter Tasks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Starter Tasks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staff/techtalks">Tech talks</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staff/tips/">Tips and tricks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tips and tricks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">staff</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/staff/backend/"><span itemprop="name">Infrastructure</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Printhost</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Printhost</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>The OCF&#x27;s print server is based around two components: <a href="https://www.cups.org/documentation.html" target="_blank" rel="noopener noreferrer">CUPS</a>, the
standard UNIX print server, and a custom print accounting system contained in
the ocflib API. CUPS is responsible for receiving print jobs over the network,
converting documents to a printer-friendly format, and delivering processed
jobs to one of the available printers. The OCF&#x27;s print accounting system,
nicknamed enforcer after one of the scripts, plugs into CUPS as a hook that
looks at jobs before and after going to the printer. It records jobs in a
database that keeps track of how many pages each user has printed, rejecting
jobs that go over quota. The high level flow of data through the print system
looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   [Application]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         | PDF or PS document</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Print spool (CUPS)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         | Raw document</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Filter(s) (ocfps)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         | Converted PS document</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Backend (Tea4CUPS)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |  Accept or reject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +&lt;------------------+[Page counter (enforcer)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |                               ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         v                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [Printer]                           |                 Remaining quota</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +                               +-------+/      \&lt;---------------+/             \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         | Status/completion time                 |ocflib|                 |Jobs database|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         v                               +-------&gt;\      /+---------------&gt;\             /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [Backend]                           |                 Job table entry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |                               +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +----------------------&gt;[Enforcer (again)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |  Log success/failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Print spool logger]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cups-pipeline-overview">CUPS pipeline overview<a class="hash-link" href="#cups-pipeline-overview" title="Direct link to heading">​</a></h2><p>The first stage of printing is handled by the application that sends the print
job, such as Evince. The application opens up a system print dialog, which gets
a list of available printers and options from the local CUPS client, which in
turn gets it from the printhost. The application renders the desired pages to a
PostScript, PDF, or other CUPS-compatible format, then sends it to the
printhost.</p><p>The CUPS server on the printhost receives the job and print options and queues
the job for printing. The actual document, plus metadata including user-set
options, is stored in the print spool at <code>/var/spool/cups</code> until a printer
becomes available to print it. The document is converted into a more
printer-friendly format before it actually reaches the printer. Once it&#x27;s ready
to print, it is sent to the printer via some backend such as IPP.</p><p>Finally, the printer accepts a PostScript document as raw data and prints it
out (some also support raster formats). This part of the process is largely
controlled by the printer&#x27;s onboard configuration, which can be modified by
visiting the printer&#x27;s IP over the web (e.g. <code>https://papercut/</code>). In the OCF&#x27;s
case, security is provided by an access control list (ACL) which accepts print
jobs from the printhost and rejects jobs from other hosts.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="filters">Filters<a class="hash-link" href="#filters" title="Direct link to heading">​</a></h3><p>CUPS handles documents of many different formats. Some typical MIME types
include <code>application/pdf</code> for raw PDF and <code>application/vnd.cups-postscript</code> for
printable PostScript. To convert between formats, CUPS runs the data through
programs called <em>filters</em>. A filter is, basically, a program that takes a
special call format, plus CUPS-specific environment variables, and converts
files from one format to another while adding special formatting options like
duplex mode.</p><p>CUPS uses not just one, but potentially several filters to get the document
into its final format. For example, a PDF file might go through <code>pdftops</code> to
convert it to PostScript, then <code>pstops</code> to insert print job options such as
duplexing, then, finally, a device-specific filter such as <code>hpcups</code>. Each
filter is associated with an internal &quot;cost&quot;, and CUPS picks the path with the
least total cost to print the document.</p><p>At the OCF, print jobs are all processed by a single filter, <a href="https://github.com/ocf/puppet/blob/master/modules/ocf_printhost/files/ocfps" target="_blank" rel="noopener noreferrer">ocfps</a>,
which converts raw PDFs to rasterized, printable PostScript. It calls on a
command-line converter to render the PDF as pixels (rasterization), then passes
the result and the rest of the arguments to standard CUPS filters. So far, this
has given us the fewest headaches in terms of malformatted output and printer
errors.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="drivers">Drivers<a class="hash-link" href="#drivers" title="Direct link to heading">​</a></h3><p>In order to know what job options are available for a particular printer and
how to convert documents to a printable format, CUPS requires large config
files called PostScript Printer Drivers (PPDs). The OCF uses a modified HP PPD
for the <a href="https://github.com/ocf/puppet/blob/master/modules/ocf_printhost/templates/cups/ppd/m806.ppd.epp" target="_blank" rel="noopener noreferrer">M806</a>. There are two versions of it: one which only allows
double-sided printing and one which only allows single-sided. This is how we
implement the &quot;double&quot; and &quot;single&quot; classes. The PPDs tell CUPS to use <code>ocfps</code>
to convert documents to PostScript, plus they turn on economode so we can
afford the toner.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="print-accounting">Print accounting<a class="hash-link" href="#print-accounting" title="Direct link to heading">​</a></h2><p>The OCF uses a virtual CUPS printer backend called <a href="https://wiki.debian.org/Tea4CUPS" target="_blank" rel="noopener noreferrer">Tea4CUPS</a> to
install a page accounting hook that runs before and after each job is actually
sent to the printer. The script is called <a href="https://github.com/ocf/puppet/blob/master/modules/ocf_printhost/files/enforcer" target="_blank" rel="noopener noreferrer">enforcer</a>, but all the
logic is contained in the <a href="https://github.com/ocf/ocflib/tree/master/ocflib/printing" target="_blank" rel="noopener noreferrer">ocflib printing package</a>. All jobs
are logged in the <code>ocfprinting</code> SQL database, including the username, print
queue, and number of pages. Several views count up the number of pages printed
by each user per day and per semester.</p><p>Page counting is actually done when the document is converted to PostScript,
since CUPS-processed PostScript includes the page count as a comment near the
top or bottom of the file. When enforcer receives a job that would put the user
over daily or semesterly quota, it emails the user and returns an error code
that cancels the job. Otherwise, it logs successful print jobs in the database
and emails users in the case a job fails.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="desktop-notifications">Desktop notifications<a class="hash-link" href="#desktop-notifications" title="Direct link to heading">​</a></h3><p>After printing a document from a desktop, lab visitors are notified when pages
are subtracted from their quota by a little popup notification. This is done by
a short daemon script, <a href="https://github.com/ocf/puppet/blob/master/modules/ocf_desktop/files/xsession/notify" target="_blank" rel="noopener noreferrer">notify script</a>, which starts upon login and
runs the <a href="/docs/staff/scripts/paper">paper command</a> every minute to see if the
quota has changed.</p><p>In the future, it would be nice to have a more robust notification system where
enforcer pushes notifications to desktops while a job is printing. This would
allow for richer notifications to be displayed; namely, alerts to show when
a job has started or finished printing, whether the job printed successfully,
and whether it went over quota. Current thinking is that this could be
implemented by broadcasting notifications to the whole network, or just the
desktops, and modifying the notify script to listen for messages about the
current user.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="see-also">See also<a class="hash-link" href="#see-also" title="Direct link to heading">​</a></h2><ul><li><a href="/docs/staff/procedures/printing">Printing maintenance</a></li><li>The <a href="https://github.com/ocf/puppet/tree/master/modules/ocf_printhost" target="_blank" rel="noopener noreferrer">ocf_printhost</a> Puppet class</li><li>The <a href="/docs/staff/scripts/paper">paper</a> command</li><li><a href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/CUPS-printing.html" target="_blank" rel="noopener noreferrer">CUPS documentation at Samba</a> (for Windows users, but has general
CUPS info as well)</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/staff/backend/printhost.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/staff/backend/munin"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Munin</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/staff/backend/prometheus"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Prometheus</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#cups-pipeline-overview" class="table-of-contents__link toc-highlight">CUPS pipeline overview</a><ul><li><a href="#filters" class="table-of-contents__link toc-highlight">Filters</a></li><li><a href="#drivers" class="table-of-contents__link toc-highlight">Drivers</a></li></ul></li><li><a href="#print-accounting" class="table-of-contents__link toc-highlight">Print accounting</a><ul><li><a href="#desktop-notifications" class="table-of-contents__link toc-highlight">Desktop notifications</a></li></ul></li><li><a href="#see-also" class="table-of-contents__link toc-highlight">See also</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Board of Directors of the Open Computing Facility.</div></div></div></footer></div>
<script src="/docs/assets/js/runtime~main.a314d0f9.js"></script>
<script src="/docs/assets/js/main.4f9c1481.js"></script>
</body>
</html>