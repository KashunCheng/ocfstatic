"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[6009],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=p(n),h=i,k=c["".concat(l,".").concat(h)]||c[h]||d[h]||r;return n?a.createElement(k,o(o({ref:t},u),{},{components:n})):a.createElement(k,o({ref:t},u))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},5880:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const r={title:"Jenkins"},o=void 0,s={unversionedId:"staff/backend/jenkins",id:"staff/backend/jenkins",title:"Jenkins",description:"Jenkins is the tool we use for continuous",source:"@site/docs/staff/backend/jenkins.md",sourceDirName:"staff/backend",slug:"/staff/backend/jenkins",permalink:"/docs/staff/backend/jenkins",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/staff/backend/jenkins.md",tags:[],version:"current",frontMatter:{title:"Jenkins"},sidebar:"tutorialSidebar",previous:{title:"Internal firewalls",permalink:"/docs/staff/backend/internal-firewalls"},next:{title:"Kerberos",permalink:"/docs/staff/backend/kerberos"}},l={},p=[{value:"Making changes to Jenkins",id:"making-changes-to-jenkins",level:2},{value:"Jenkins security model",id:"jenkins-security-model",level:2},{value:"Jenkins for GitHub projects",id:"jenkins-for-github-projects",level:2},{value:"On the master branch",id:"on-the-master-branch",level:3},{value:"Adding a &quot;Build Status&quot; badge to the README",id:"adding-a-build-status-badge-to-the-readme",level:4},{value:"Building and tagging pull requests",id:"building-and-tagging-pull-requests",level:3}],u={toc:p};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://jenkins.ocf.berkeley.edu/"},"Jenkins")," is the tool we use for continuous\nintegration and continuous delivery (TM) at OCF. All that means is that when\nyou push code,"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Jenkins will test that code,"),(0,i.kt)("li",{parentName:"ul"},"Jenkins will build that code (if applicable),"),(0,i.kt)("li",{parentName:"ul"},"and then Jenkins will deploy that code.")),(0,i.kt)("p",null,"Ideally all projects at OCF will go through this pipeline of being tested\nbefore deployed, though currently some don't (or some only use some portion,\nsuch as deploying without any tests)."),(0,i.kt)("h2",{id:"making-changes-to-jenkins"},"Making changes to Jenkins"),(0,i.kt)("p",null,"Anyone in group ",(0,i.kt)("inlineCode",{parentName:"p"},"ocfroot")," can log in to Jenkins (using their OCF username and\npassword) and will have full access to Jenkins."),(0,i.kt)("p",null,"Sadly, while the installation of Jenkins is controlled via Puppet, its\nconfiguration is not. Configuring by Puppet would be nice, but it would mean\nchanges would need to be made inside Puppet instead of the web UI."),(0,i.kt)("p",null,"In practice it seems most people in industry are still using the web UI for\nconfiguration anyway."),(0,i.kt)("h2",{id:"jenkins-security-model"},"Jenkins security model"),(0,i.kt)("p",null,"There are three users configured on the Jenkins server (",(0,i.kt)("inlineCode",{parentName:"p"},"reaper"),"):"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"jenkins"),", the user created by the Debian package. It is used for running the\nJenkins master but not for performing any work.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"jenkins-slave"),", a user we create. It is used for running build jobs with\npotentially untrusted code. ",(0,i.kt)("strong",{parentName:"p"},"However,")," it's not secure enough to run\ntotally untrusted code, since all jobs run under this user.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"jenkins-deploy"),", a user we create. It is used for running build jobs tagged\n",(0,i.kt)("inlineCode",{parentName:"p"},"deploy"),", whose only purpose is intended to be ",(0,i.kt)("em",{parentName:"p"},"deploying")," code which has\nbeen built or tested in a previous step. The user has a Kerberos keytab for\nthe ",(0,i.kt)("inlineCode",{parentName:"p"},"ocfdeploy")," user and our PyPI key in its home directory. Jobs such as\n",(0,i.kt)("inlineCode",{parentName:"p"},"upload-deb")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"puppet-trigger")," fall under this user."))),(0,i.kt)("p",null,'Within Jenkins, we configure two "slaves" which are really on the same server,\nbut execute by launching the ',(0,i.kt)("inlineCode",{parentName:"p"},"slave.jar")," file as the ",(0,i.kt)("inlineCode",{parentName:"p"},"jenkins-slave")," or\n",(0,i.kt)("inlineCode",{parentName:"p"},"jenkins-deploy")," user (via passwordless sudo from the ",(0,i.kt)("inlineCode",{parentName:"p"},"jenkins")," user,\neffectively dropping permissions)."),(0,i.kt)("p",null,"The jobs are configured to run on either ",(0,i.kt)("inlineCode",{parentName:"p"},"jenkins-slave")," (the default) or\n",(0,i.kt)("inlineCode",{parentName:"p"},"jenkins-deploy")," (for deploy jobs)."),(0,i.kt)("p",null,"This is a bit complicated, but it allows us both better security (we no longer\nhave to worry that anybody who can get some code built can become ocfdeploy,\nwhich is a privileged user account) and protects Jenkins somewhat against bad\njobs that might e.g. delete files or crash processes."),(0,i.kt)("p",null,"Of course, in many cases once code builds successfully, we ship it off\nsomewhere where it gets effectively run as root anyway. But this feels a little\nsafer."),(0,i.kt)("h2",{id:"jenkins-for-github-projects"},"Jenkins for GitHub projects"),(0,i.kt)("h3",{id:"on-the-master-branch"},"On the master branch"),(0,i.kt)("p",null,"To test GitHub projects when you push to master:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Configure the "GitHub Project" URL to point to the main page of the project\n(for example, ',(0,i.kt)("a",{parentName:"p",href:"https://github.com/ocf/puppet/"},"https://github.com/ocf/puppet/"),").")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Under "Source Code Management", select "Git" and add the repository URL (for\nexample, ',(0,i.kt)("a",{parentName:"p",href:"https://github.com/ocf/puppet/"},"https://github.com/ocf/puppet/"),").")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Under "Build Triggers", check "Build when a change is pushed to GitHub".')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'On GitHub, go to "Settings" then "Webhooks & services". Add a new "Jenkins\n(GitHub Plugin)" service with URL\n',(0,i.kt)("inlineCode",{parentName:"p"},"https://jenkins.ocf.berkeley.edu/github-webhook/"),"."))),(0,i.kt)("p",null,"You can create additional steps or organize pipelines if desired (for example,\nif you'd like to first test and then deploy)."),(0,i.kt)("h4",{id:"adding-a-build-status-badge-to-the-readme"},'Adding a "Build Status" badge to the README'),(0,i.kt)("p",null,'You might like to add a fancy "Build Status" badge to the README. From the\nproject page, choose the "Embeddable Build Status" icon, then choose "Markdown\n(with view), unprotected". You can optionally change the link to point to the\npipeline view rather ther than just the individual job.'),(0,i.kt)("h3",{id:"building-and-tagging-pull-requests"},"Building and tagging pull requests"),(0,i.kt)("p",null,"Jenkins can build and tag pull requests with their build status, similar to\nTravis. To configure this for a repository, create a new job specifically for\ntesting pull requests. For example, ",(0,i.kt)("inlineCode",{parentName:"p"},"puppet-test-pr"),"."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Configure the "GitHub Project" URL to point to the main page of the project\n(for example, ',(0,i.kt)("a",{parentName:"p",href:"https://github.com/ocf/puppet/"},"https://github.com/ocf/puppet/"),").")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Under "Source Code Management", select "Git" and add the repository URL (for\nexample, ',(0,i.kt)("a",{parentName:"p",href:"https://github.com/ocf/puppet/"},"https://github.com/ocf/puppet/"),").")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Under "Source Code Management", change "Branch Specifier" to ',(0,i.kt)("inlineCode",{parentName:"p"},"${sha1}"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Also under "Source Code Management", change "Refspec" (it\'s under Advanced)\nto ',(0,i.kt)("inlineCode",{parentName:"p"},"+refs/pull/*:refs/remotes/origin/pr/*"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Under "Build Triggers", check "GitHub Pull Request Builder", and then check\n"Use github hooks for build triggering".')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Under "GitHub Pull Request Builder", delete all lines under "Admin List" (if\nthere are any). Add "ocf" as the only line to the "List of organizations"\nbox.')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'On GitHub, under "Settings" and "Webhooks & services", add a new webhook\nwith payload URL ',(0,i.kt)("inlineCode",{parentName:"p"},"https://jenkins.ocf.berkeley.edu/ghprbhook/"),", content type\n",(0,i.kt)("inlineCode",{parentName:"p"},"application/json"),", and the secret (it's in ",(0,i.kt)("inlineCode",{parentName:"p"},"supernova:/opt/passwords"),").\nChoose to trigger only on certain events:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Commit comment"),(0,i.kt)("li",{parentName:"ul"},"Issue comment"),(0,i.kt)("li",{parentName:"ul"},"Issues"),(0,i.kt)("li",{parentName:"ul"},"Pull Request"),(0,i.kt)("li",{parentName:"ul"},"Pull Request view comment")),(0,i.kt)("p",{parentName:"li"},"(These might not all be necessary, but I don't know the exact list.)")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'On GitHub, add the "Bots" group admin access to the repository. This is\nnecessary so that it can set commit statuses.'))))}d.isMDXComponent=!0}}]);