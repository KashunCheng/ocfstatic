"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[5581],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>c});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=p(a),c=r,h=m["".concat(l,".").concat(c)]||m[c]||u[c]||i;return a?n.createElement(h,o(o({ref:t},d),{},{components:a})):n.createElement(h,o({ref:t},d))}));function c(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},1408:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var n=a(7462),r=(a(7294),a(3905));const i={title:"Setting up mdraid on servers"},o=void 0,s={unversionedId:"staff/procedures/setting-up-mdraid",id:"staff/procedures/setting-up-mdraid",title:"Setting up mdraid on servers",description:"Setting up a new server involves putting in all its new drives, turning off",source:"@site/docs/staff/procedures/setting-up-mdraid.md",sourceDirName:"staff/procedures",slug:"/staff/procedures/setting-up-mdraid",permalink:"/docs/staff/procedures/setting-up-mdraid",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/staff/procedures/setting-up-mdraid.md",tags:[],version:"current",frontMatter:{title:"Setting up mdraid on servers"},sidebar:"tutorialSidebar",previous:{title:"Setting up bridging and link aggregation",permalink:"/docs/staff/procedures/setting-up-lacp"},next:{title:"SSHing into Supernova",permalink:"/docs/staff/procedures/ssh-supernova"}},l={},p=[{value:"Aside: why software RAID instead of MegaRAID?",id:"aside-why-software-raid-instead-of-megaraid",level:3},{value:"Instructions",id:"instructions",level:3},{value:"MegaRAID setup",id:"megaraid-setup",level:4},{value:"Software RAID setup",id:"software-raid-setup",level:4},{value:"WebCLI setup",id:"webcli-setup",level:4},{value:"Cleanup",id:"cleanup",level:4}],d={toc:p};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Setting up a new server involves putting in all its new drives, turning off\nMegaRAID, setting up mdraid (Linux software RAID) on them, and then installing\nthe operating system. It requires quite a few tricky steps."),(0,r.kt)("p",null,"The below steps were written for ",(0,r.kt)("inlineCode",{parentName:"p"},"jaws"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"pandemic"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"hal")," which have LSI RAID\ncards that need to be put into JBOD mode. The intructions will vary without LSI\nhardware RAID (which we don't use)."),(0,r.kt)("p",null,"Also, MegaCLI isn't very consistent between versions, and in general it's\nextremely buggy and poorly-written. So you might have to modify the\ninstructions slightly to get something that works."),(0,r.kt)("h3",{id:"aside-why-software-raid-instead-of-megaraid"},"Aside: why software RAID instead of MegaRAID?"),(0,r.kt)("p",null,"Because the software that comes with LSI's RAID controllers is terrible. It's\ncalled MegaCLI and you will never read anything good about it."),(0,r.kt)("p",null,"Examples of problems we've had in the past with MegaCLI:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Random commands just don't work on some versions (but do work on others)."),(0,r.kt)("li",{parentName:"ul"},"Out of the ~5 versions we tried, all segfaulted on at least one of our\nphysical servers, so we had to mantain two different versions of MegaCLI."),(0,r.kt)("li",{parentName:"ul"},'It\'s ridiculously hard to use and lacking in documentation. The CLI design is\njunk. What does "RAID Level: Primary-1, Secondary-0, RAID Lvl Qualifier-0"\nmean without Googling it?'),(0,r.kt)("li",{parentName:"ul"},"Poor insight into drive health (can't just use smartctl/smartd), we had to\nwrite our own tools for it."),(0,r.kt)("li",{parentName:"ul"},"No TRIM (needed for fast writes on our SSDs).")),(0,r.kt)("p",null,"Plus, it's proprietary, which makes getting it installed automatically\ndifficult."),(0,r.kt)("p",null,"We are sacrificing a bit of measurable performance (mostly because we can't use\nthe battery-backed write cache), but we find it to be a small amount (and worth\nthe operational benefits of never having to touch MegaCLI again)."),(0,r.kt)("h3",{id:"instructions"},"Instructions"),(0,r.kt)("p",null,"These assume you're willing to destroy all the data on the server and rebuild\nit. They also assume you're currently using MegaRAID. If you're not using\nMegaRAID or MegaRAID was already set up and you are booting off the first drive\n(",(0,r.kt)("inlineCode",{parentName:"p"},"/dev/sda"),"), then you probably don't have to change anything and can skip the\nMegaRAID setup steps."),(0,r.kt)("p",null,"These commands work pretty reliably but you should still think before pressing\nenter, because they might need some adjustment."),(0,r.kt)("h4",{id:"megaraid-setup"},"MegaRAID setup"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"On boot, enter the LSI pre-boot CLI (press ",(0,r.kt)("inlineCode",{parentName:"p"},"Ctrl-Y")," at the right time). The\nsyntax in the pre-boot CLI seems to be the same as MegaCLI.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Remove all logical drives and put the physical drives in JBOD mode:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"$ -CfgLdDel -LALL -aALL\n$ -PDMakeGood -PhysDrv[252:0,252:1,252:2,252:3] -force -a0\n$ -AdpSetProp EnableJBOD 1 -aALL\n$ -PDMakeJBOD -PhysDrv[252:0,252:1,252:2,252:3] -a0\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"note: I got an error on jaws on the ",(0,r.kt)("inlineCode",{parentName:"em"},"PDMakeJBOD"),", but it worked anyway")))),(0,r.kt)("h4",{id:"software-raid-setup"},"Software RAID setup"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Boot into finnix and figure out which drives you want in the RAID.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Make new partition tables on each drive and one large partition to hold the\ndata."),(0,r.kt)("p",{parentName:"li"},"You should make the data partition take almost all of the space on the\ndrive, but not all the way to the end (leave a GB or two). The reason is so\nthat you can replace the drive when it fails with another drive which isn't\nquite the same size (it might be a few bytes smaller)."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'for device in /dev/sda /dev/sdb /dev/sdc /dev/sdd; do\n    parted "$device" mklabel gpt\n    parted "$device" mkpart primary 10MB 510GB\ndone\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Pick one disk to hold GRUB (I usually do ",(0,r.kt)("inlineCode",{parentName:"p"},"/dev/sda"),") and do:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"parted /dev/sda mkpart primary ext4 1 5\nparted /dev/sda\n")),(0,r.kt)("p",{parentName:"li"},"Figure out the new partition number (typically 2 since it was the second\npartition created), then run:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"parted /dev/sda set 2 bios_grub on\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Set up RAID 10, and make sure to use the data partitions (like ",(0,r.kt)("inlineCode",{parentName:"p"},"/dev/sda1"),"\nand not the entire drive)."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mdadm --create -v /dev/md0 --level=raid10 --raid-devices=4 \\\n    /dev/sda1 /dev/sdb1 /dev/sdc1 /dev/sdd1\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Set up a GPT partition table on the new RAID volume. ",(0,r.kt)("strong",{parentName:"p"},"Don't forget this or\nyou'll be sorry when you have to abandon the Debian install.")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"parted /dev/md0 mklabel gpt\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Back in Finnix, run ",(0,r.kt)("inlineCode",{parentName:"p"},"sync")," to write any changes in memory to disk.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Reboot and launch the Debian installer.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},'Make sure not to do the "OCF Automated Install" at PXE, do an "expert\ninstall" instead. sorry.')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"When you get to partitioning, use common sense. I recommend switching to\nanother TTY (",(0,r.kt)("inlineCode",{parentName:"p"},"Ctrl+Alt+F2"),") and using fdisk to create ~40GB root, ~8GB swap,\nand the rest as one partition (for LVM). These should be created on the RAID\ndevice (typically ",(0,r.kt)("inlineCode",{parentName:"p"},"/dev/md0")," if you only have one RAID array).")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"When asked, install GRUB on the same disk as in step 5 (I recommend\n",(0,r.kt)("inlineCode",{parentName:"p"},"/dev/sda"),")"))),(0,r.kt)("h4",{id:"webcli-setup"},"WebCLI setup"),(0,r.kt)("p",null,"This probably only has to be done if this server is booting into a different\ndrive slot than it has used before. Try booting and see what happens, and if you\ncan't, then try messing with this."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Boot into WebCLI (",(0,r.kt)("inlineCode",{parentName:"p"},"Ctrl-H")," on boot at the LSI screen)")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In WebCLI, figure out which disk you added your boot to, and set it as\nbootable. If you can't find the \"Make Bootable\" option on the physical drive\npage, it's probably already bootable. Maybe just restart and see if it\nworks."),(0,r.kt)("p",{parentName:"li"},"I can't find a way to match drive letters inside WebCLI, so you might just\nneed to try all of them in your new array until it works, sorry."))),(0,r.kt)("h4",{id:"cleanup"},"Cleanup"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Undo everything from above on ",(0,r.kt)("inlineCode",{parentName:"p"},"pestilence")," (enable puppet again, just run\npuppet again to revert any changes, and start the DHCP server again)")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"You're done!"))))}u.isMDXComponent=!0}}]);