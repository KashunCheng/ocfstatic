"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[6650],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),m=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=m(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=m(n),d=o,h=c["".concat(l,".").concat(d)]||c[d]||u[d]||a;return n?r.createElement(h,s(s({ref:t},p),{},{components:n})):r.createElement(h,s({ref:t},p))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=c;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var m=2;m<a;m++)s[m]=n[m];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},6449:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>m});var r=n(7462),o=(n(7294),n(3905));const a={title:"migrate-vm: migrate VMs between hosts"},s=void 0,i={unversionedId:"staff/scripts/migrate-vm",id:"staff/scripts/migrate-vm",title:"migrate-vm: migrate VMs between hosts",description:"Usage",source:"@site/docs/staff/scripts/migrate-vm.md",sourceDirName:"staff/scripts",slug:"/staff/scripts/migrate-vm",permalink:"/docs/staff/scripts/migrate-vm",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/staff/scripts/migrate-vm.md",tags:[],version:"current",frontMatter:{title:"migrate-vm: migrate VMs between hosts"},sidebar:"tutorialSidebar",previous:{title:"lab-wakeup: wake up suspended desktops",permalink:"/docs/staff/scripts/lab-wakeup"},next:{title:"note: add notes to a user account",permalink:"/docs/staff/scripts/note"}},l={},m=[{value:"Usage",id:"usage",level:2},{value:"Steps performed",id:"steps-performed",level:2},{value:"Final steps",id:"final-steps",level:2},{value:"Assumptions Made",id:"assumptions-made",level:2}],p={toc:m};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"usage"},"Usage"),(0,o.kt)("p",null,"This script is used for migrating ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.debian.org/KVM"},"KVM virtual machines")," between physical\nhosts. The script should be run on the new host for the virtual machine using\nthe following format. The first hostname specified in the command is what\nphysical host to move the virtual machine from, and the second one is the name\nof the virtual machine to move."),(0,o.kt)("p",null,"For example, the following command moves ",(0,o.kt)("inlineCode",{parentName:"p"},"supernova")," from ",(0,o.kt)("inlineCode",{parentName:"p"},"jaws")," to whatever\nKVM host the command is run on:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo migrate-vm jaws:supernova\n")),(0,o.kt)("h2",{id:"steps-performed"},"Steps performed"),(0,o.kt)("p",null,"To move the virtual machine, ",(0,o.kt)("inlineCode",{parentName:"p"},"migrate-vm")," performs the following steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Shuts down the virtual machine on the old host."),(0,o.kt)("li",{parentName:"ol"},"Creates a new ",(0,o.kt)("a",{parentName:"li",href:"https://wiki.debian.org/LVM"},"LVM")," volume on the new host with the correct size."),(0,o.kt)("li",{parentName:"ol"},"Securely copies the virtual machine's disk from the old host to the new\nhost."),(0,o.kt)("li",{parentName:"ol"},"Checksums both the old and the new disks on each machine to ensure they\nmatch."),(0,o.kt)("li",{parentName:"ol"},"Imports the KVM domain definition from the old host to the new host.")),(0,o.kt)("h2",{id:"final-steps"},"Final steps"),(0,o.kt)("p",null,"After the virtual machine has been transferred between hosts, make sure the\nguest works on the new host. If moving from ",(0,o.kt)("inlineCode",{parentName:"p"},"hal"),", you might need to delete the\ncustom CPU definition section from the KVM XML to get the virtual machine to\nstart. To edit the XML definition, run ",(0,o.kt)("inlineCode",{parentName:"p"},"sudo virsh edit ${hostname}"),". The\nsection to delete looks like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-xml"},"<cpu mode='custom' match='exact'>\n  <model fallback='allow'>Opteron_G3</model>\n</cpu>\n")),(0,o.kt)("p",null,"Then, after everything works, you should remove the old KVM and LVM definitions\non only the ",(0,o.kt)("strong",{parentName:"p"},"old")," host:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo virsh undefine ${hostname}\nsudo lvremove /dev/vg/${hostname}\n")),(0,o.kt)("h2",{id:"assumptions-made"},"Assumptions Made"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The LVM volume group ",(0,o.kt)("inlineCode",{parentName:"li"},"/dev/vg")," is used on both the old and new host."),(0,o.kt)("li",{parentName:"ul"},"Virtual machines are stored at ",(0,o.kt)("inlineCode",{parentName:"li"},"/dev/vg/${hostname}")," on both hosts.")))}u.isMDXComponent=!0}}]);